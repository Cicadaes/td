<div *ngIf="!_isRestApi" nz-row class="metadata-step2-content">

    <div nz-row class="metadata-step2-head clrfix">
        <div class="head-item fl">选择{{physicalType}}</div>
        <div class="head-item fr">
            <!-- <nz-input [nzType]="'search'" [nzPlaceHolder]="'输入关键字搜索'" [(ngModel)]="searchText" style="width: 200px;" (ngModelChange)="onSearch($event)">
                <ng-template #addonAfter>
                    <i class="anticon anticon-close"></i>
                </ng-template>
            </nz-input> -->
        </div>
        <!-- <div nz-col [nzSpan]="8">
                <cm-button>
                    <button nz-button [nzType]="'primary'" (click)="getPhysicalTable()">获取{{ physicalType }}</button>
                </cm-button>
            </div> -->

    </div>
    <div class="table-box clrfix">
        <div class="table-left">
            <cm-table>
                <nz-table #nzTable1 [nzDataSource]="physicalList" [nzIsPagination]="false" [nzScroll]="{ y: 460 }">
                    <ng-template *ngIf="physicalList.length > 11" #nzFixedHeader>
                        <thead nz-thead>
                            <tr>
                                <th nz-th style="width:65px">
                                </th>
                                <th class="clrfix" nz-th>
                                    <span class="fl" style="margin-top:3px">{{ physicalType }}名称</span>
                                    <cm-input class="fr">
                                        <nz-input [nzType]="'search'" [nzPlaceHolder]="'输入关键字搜索'" [(ngModel)]="searchText" style="width: 200px;" (ngModelChange)="onSearch($event)">
                                            <ng-template #addonAfter>
                                                <i class="anticon anticon-close"></i>
                                            </ng-template>
                                        </nz-input>
                                    </cm-input>

                                </th>
                            </tr>
                        </thead>
                    </ng-template>
                    <thead *ngIf="physicalList.length < 12" nz-thead>
                        <tr>
                            <th nz-th style="width:65px">
                            </th>
                            <th class="clrfix" nz-th>
                                <span class="fl">{{ physicalType }}名称</span>
                                <cm-input class="fr">
                                    <nz-input [nzType]="'search'" [nzPlaceHolder]="'输入关键字搜索'" [(ngModel)]="searchText" style="width: 200px;" (ngModelChange)="onSearch($event)">
                                        <ng-template #addonAfter>
                                            <i class="anticon anticon-close"></i>
                                        </ng-template>
                                    </nz-input>
                                </cm-input>

                            </th>
                        </tr>
                    </thead>
                    <tbody nz-tbody>
                        <tr [ngClass]="{'itemSelected': data.isSelected}" nz-tbody-tr *ngFor="let data of nzTable1.data;let i=index" (click)="selectDataTable($event,data)">
                            <td nz-td style="width:65px">
                                <nz-radio-group [(ngModel)]="tableName">
                                    <label nz-radio [nzValue]="data.tableName"></label>
                                </nz-radio-group>
                            </td>
                            <td nz-td>
                                <p class="table-td" [title]="data.tableName">
                                    {{data.tableName}}
                                </p>
                            </td>
                        </tr>
                    </tbody>
                </nz-table>
            </cm-table>
        </div>
        <div class="table-right" *ngIf="physicalList.length > 0">
            <cm-table>
                <nz-table #nzTable [nzShowTotal]="true" [nzDataSource]="physicalDetail" [nzIsPagination]="false" [nzScroll]="{ y: 460 }"
                    [(nzPageIndex)]="pageIndex">
                    <ng-template *ngIf="physicalDetail.length > 11" #nzFixedHeader>
                        <thead nz-thead>
                            <tr>
                                <th nz-th [nzWidth]="'290px'">
                                    <span>字段</span>
                                </th>
                                <th nz-th>
                                    <span>类型</span>
                                </th>
                                <th nz-th>
                                    <span>描述</span>
                                </th>
                            </tr>
                        </thead>
                    </ng-template>
                    <thead nz-thead *ngIf="physicalDetail.length < 12">
                        <tr>
                            <th nz-th [nzWidth]="'290px'">
                                <span>字段</span>
                            </th>
                            <th nz-th>
                                <span>类型</span>
                            </th>
                            <th nz-th>
                                <span>描述</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody nz-tbody>
                        <tr nz-tbody-tr *ngFor="let data of nzTable.data;let i=index">
                            <td nz-td>
                                <p class="table-td" [title]="data.columnName" style="max-width:240px">
                                    {{data.columnName}}
                                </p>
                            </td>
                            <td nz-td>{{data.columnType}}</td>
                            <td nz-td>
                                <p class="table-td" [title]="data.columnDescription" style="max-width:130px">
                                    {{data.columnDescription}}
                                </p>
                            </td>
                        </tr>
                    </tbody>
                </nz-table>
            </cm-table>
        </div>
    </div>
    <div *ngIf="step2IsFalse" class="errorInfo">无法获取有效的{{physicalType}}（数据{{physicalType}}不存在或者{{physicalType}}字段不存在）</div>
</div>

<div *ngIf="_isRestApi" class="metadata-step2-content metadata-step2-restapi">
    <div class="metadataStep2ListTitle">
        <span class="head">
            API信息
        </span>
        <i class="anticon anticon-info-circle"></i>
        <span class="text">
            该接口必须实现TalkingData Cube RestAPI 
            <a target="_blank" routerLink="/restapidoc"> 接口规范</a>
        </span>
    </div>

    <cm-form>
        <form nz-form [formGroup]="metadataStep2ListForm" class="cm-advanced-search-form" (ngSubmit)="submitForm($event)">
            <div class="metadataStep2ListForm clrfix">
                <div class="clrfix" nz-form-item nz-row>
                    <div nz-form-label>
                        <label nz-form-item-required>Rest API URL</label>
                    </div>
                    <div nz-form-control nzHasFeedback>
                        <cm-input>
                            <nz-input (keyup)="restapiUrlChange()" [(ngModel)]="tableName" [nzSize]="'large'" [nzPlaceHolder]="'请输入内容'" [formControlName]="'restapiUrl'"
                                [nzId]="'restapiUrl'"></nz-input>
                        </cm-input>
                        <div style="text-align:left;" nz-form-explain *ngIf="getFormControl('restapiUrl').dirty && getFormControl('restapiUrl').hasError('required')">{{ errorInfo.required }}</div>
                        <div style="text-align:left;" nz-form-explain *ngIf="getFormControl('restapiUrl').dirty && getFormControl('restapiUrl').hasError('rightful')">{{ errorInfo.rightful }}</div>
                        <div style="text-align:left;" nz-form-explain *ngIf="getFormControl('restapiUrl').dirty && getFormControl('restapiUrl').hasError('minlength')">{{ errorInfo.minlength }}</div>
                    </div>
                </div>

                <div class="clrfix" nz-form-item>
                    <div nz-form-label>
                        <label>HTTP Method</label>
                    </div>
                    <div nz-form-control>
                        <cm-input>
                            <nz-input [nzReadonly]="true" [formControlName]="'httpMethod'" [nzSize]="'large'" [nzPlaceHolder]="''" [ngModel]="'POST'"></nz-input>
                        </cm-input>
                    </div>
                </div>
            </div>
        </form>
    </cm-form>

</div>

<div *ngIf="_isRestApi" class="metadata-step2-content">
    <div nz-row class="metadata-step2-head clrfix">
        <div class="head-item fl">API参数</div>
        <div class="head-item refreshBtn fl" (click)="getParams()">
            获取/刷新参数
        </div>
    </div>
    <div class="restapi-table-box">
        <cm-table>
            <nz-table #nzTable [nzShowTotal]="true" [nzBordered]="true" [nzDataSource]="physicalDetail">

                <thead nz-thead>
                    <tr>
                        <th nz-th>
                            <span>参数名称</span>
                        </th>
                        <th nz-th>
                            <span>输入输出</span>
                        </th>
                        <th nz-th>
                            <span>参数类型</span>
                        </th>
                        <th nz-th>
                            <span>支持的聚合运算</span>
                        </th>
                        <th nz-th>
                            <span>时间间隔粒度</span>
                        </th>
                    </tr>
                </thead>
                <tbody nz-tbody>
                    <tr nz-tbody-tr *ngFor="let data of nzTable.data;let i=index">
                        <td nz-td>
                            <p class="table-td" [title]="data.name">
                                {{data.name}}
                            </p>
                        </td>
                        <td nz-td *ngIf="_isRestApi && data.isInput">输入参数</td>
                        <td nz-td *ngIf="_isRestApi && !data.isInput">输出参数</td>
                        <td nz-td>
                            {{data.type}}
                        </td>
                        <td nz-td>
                            {{ data.aggregators?.join('、') }}
                        </td>
                        <td nz-td>
                            {{ data.interval?.join('、') }}
                        </td>
                    </tr>
                </tbody>
            </nz-table>
        </cm-table>

    </div>
    <label *ngIf="physicalDetail.length > 0" class="restapiPage" nz-checkbox [nzDisabled]="true" [(ngModel)]="supportsLimit">
        <span>支持分页</span>
    </label>
    <div *ngIf="step2IsFalse" class="errorInfo">请确认RESTAPI的正确性</div>
</div>